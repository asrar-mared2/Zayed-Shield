# Ø§Ù„Ù…Ø³Ø§Ø±: .github/workflows/fortify.yml
# ğŸ° Ø§Ù„Ù…Ø§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­ØµÙŠÙ† ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©
# Ù†Ø¸Ø§Ù… Ù…ØªÙ‚Ø¯Ù… Ù„ØªØ­ØµÙŠÙ† ÙˆØªÙ‚ÙˆÙŠØ© Ø¯ÙØ§Ø¹Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¶Ø¯ Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù‡Ø¬Ù…Ø§Øª

name: ğŸ° Ø§Ù„Ù…Ø§Ø±Ø¯ Ø§Ù„Ø±Ù‚Ù…ÙŠ - Ø§Ù„ØªØ­ØµÙŠÙ† Ø§Ù„Ø£Ù…Ù†ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - '**.js'
      - '**.ts'
      - '**.py'
      - '**.java'
      - '**.go'
      - 'Dockerfile'
      - 'package*.json'
      - 'requirements.txt'
      - 'pom.xml'
      - 'build.gradle'
  
  pull_request:
    branches: [ main, master ]
  
  schedule:
    # ØªØ­ØµÙŠÙ† Ø£Ø³Ø¨ÙˆØ¹ÙŠ ÙƒØ§Ù…Ù„
    - cron: '0 3 * * 0'  # ÙƒÙ„ Ø£Ø­Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø© 3 ØµØ¨Ø§Ø­Ø§Ù‹
  
  workflow_dispatch:
    inputs:
      fortification_level:
        description: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ­ØµÙŠÙ†'
        required: true
        default: 'maximum'
        type: choice
        options:
          - basic
          - standard
          - advanced
          - maximum
          - paranoid
      enable_hardening:
        description: 'ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ‚ÙˆÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©'
        required: false
        type: boolean
        default: true
      auto_fix:
        description: 'Ø¥ØµÙ„Ø§Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø´Ø§ÙƒÙ„'
        required: false
        type: boolean
        default: false

# Ø£Ø°ÙˆÙ†Ø§Øª ØµØ§Ø±Ù…Ø© Ù„Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù‚ØµÙˆÙ‰
permissions:
  contents: write
  security-events: write
  pull-requests: write
  issues: write
  actions: read
  checks: write
  deployments: write

env:
  FORTIFY_VERSION: '23.2.0'
  SONAR_VERSION: 'latest'
  SNYK_VERSION: 'latest'
  FORTIFICATION_LEVEL: ${{ github.event.inputs.fortification_level || 'maximum' }}
  AUTO_FIX: ${{ github.event.inputs.auto_fix || 'false' }}

jobs:
  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ù…Ù†ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„
  # ========================================
  security-assessment:
    name: ğŸ” Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ù…Ù†ÙŠ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      risk_level: ${{ steps.assess.outputs.risk_level }}
      vulnerabilities_count: ${{ steps.assess.outputs.vuln_count }}
      fortification_needed: ${{ steps.assess.outputs.needs_fortify }}
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ” ØªØ­Ù„ÙŠÙ„ Ø³Ø·Ø­ Ø§Ù„Ù‡Ø¬ÙˆÙ…
        id: assess
        run: |
          echo "ğŸ” ØªØ­Ù„ÙŠÙ„ Ø³Ø·Ø­ Ø§Ù„Ù‡Ø¬ÙˆÙ…..."
          
          # Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ¹Ø±Ø¶
          exposure_score=0
          
          # ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
          if [ -d ".env" ] || [ -f ".env" ]; then
            exposure_score=$((exposure_score + 10))
          fi
          
          # ÙØ­Øµ Ø§Ù„Ù…Ù†Ø§ÙØ° Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
          open_ports=$(grep -r "listen.*[0-9]\{4,5\}" . --include="*.js" --include="*.py" | wc -l)
          exposure_score=$((exposure_score + open_ports * 2))
          
          # ÙØ­Øµ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„ API
          api_endpoints=$(grep -r "app\.(get|post|put|delete)" . --include="*.js" | wc -l)
          exposure_score=$((exposure_score + api_endpoints))
          
          # ÙØ­Øµ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          db_usage=$(grep -r "mongoose\|sequelize\|mysql\|postgres" . --include="*.js" | wc -l)
          exposure_score=$((exposure_score + db_usage * 3))
          
          # ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±
          if [ $exposure_score -lt 20 ]; then
            risk_level="LOW"
          elif [ $exposure_score -lt 50 ]; then
            risk_level="MEDIUM"
          elif [ $exposure_score -lt 100 ]; then
            risk_level="HIGH"
          else
            risk_level="CRITICAL"
          fi
          
          echo "risk_level=$risk_level" >> $GITHUB_OUTPUT
          echo "vuln_count=$exposure_score" >> $GITHUB_OUTPUT
          echo "needs_fortify=true" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±: $risk_level"
          echo "ğŸ¯ Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ¹Ø±Ø¶: $exposure_score"
      
      - name: ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        run: |
          cat << EOF > assessment-report.md
          # ğŸ” ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ù…Ù†ÙŠ - Digital Warrior Secrets
          
          ## ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
          - **Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±**: ${{ steps.assess.outputs.risk_level }}
          - **Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ¹Ø±Ø¶**: ${{ steps.assess.outputs.vuln_count }}
          - **Ø§Ù„ØªØ§Ø±ÙŠØ®**: $(date '+%Y-%m-%d %H:%M:%S')
          
          ## ğŸ¯ Ø§Ù„ØªÙˆØµÙŠØ§Øª
          - ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¥Ù„Ù‰ ØªØ­ØµÙŠÙ† ÙÙˆØ±ÙŠ
          - ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„ØµØ§Ø±Ù…Ø©
          - Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„
          
          EOF
          
          cat assessment-report.md
      
      - name: ğŸ“¤ Ø±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
        uses: actions/upload-artifact@v4
        with:
          name: security-assessment
          path: assessment-report.md
          retention-days: 90

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ­ØµÙŠÙ† Fortify Ø§Ù„Ø´Ø§Ù…Ù„
  # ========================================
  fortify-sca-scan:
    name: ğŸ›¡ï¸ Fortify SCA - Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
    runs-on: ubuntu-latest
    needs: security-assessment
    timeout-minutes: 45
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Java Ù„Ù„Ù€ Fortify
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
      
      - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: |
          if [ -f package.json ]; then
            npm ci --prefer-offline
          fi
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: ğŸ›¡ï¸ Fortify SCA - Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù…Ø³Ø­
        run: |
          echo "ğŸ›¡ï¸ Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Fortify SCA..."
          
          # Ù…Ø­Ø§ÙƒØ§Ø© Fortify (ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ø³ØªØ®Ø¯Ù… Fortify Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)
          cat << 'EOF' > fortify-analysis.sh
          #!/bin/bash
          
          echo "ğŸ” Fortify Static Code Analyzer"
          echo "================================"
          
          # ØªØ­Ù„ÙŠÙ„ JavaScript
          echo "ğŸ“Š ØªØ­Ù„ÙŠÙ„ JavaScript/TypeScript..."
          find . -name "*.js" -o -name "*.ts" | while read file; do
            # ÙØ­Øµ SQL Injection
            if grep -n "query.*+.*req\." "$file"; then
              echo "ğŸš¨ SQL Injection Ù…Ø­ØªÙ…Ù„: $file"
            fi
            
            # ÙØ­Øµ XSS
            if grep -n "innerHTML.*=" "$file" | grep -v "sanitize"; then
              echo "âš ï¸ XSS Ù…Ø­ØªÙ…Ù„: $file"
            fi
            
            # ÙØ­Øµ Path Traversal
            if grep -n "readFile.*req\." "$file"; then
              echo "ğŸš¨ Path Traversal Ù…Ø­ØªÙ…Ù„: $file"
            fi
          done
          
          # ØªØ­Ù„ÙŠÙ„ Python
          echo "ğŸ“Š ØªØ­Ù„ÙŠÙ„ Python..."
          find . -name "*.py" | while read file; do
            # ÙØ­Øµ Command Injection
            if grep -n "os.system\|subprocess.call" "$file" | grep "request\|input"; then
              echo "ğŸš¨ Command Injection Ù…Ø­ØªÙ…Ù„: $file"
            fi
            
            # ÙØ­Øµ Pickle
            if grep -n "pickle.loads" "$file"; then
              echo "âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Pickle ØºÙŠØ± Ø¢Ù…Ù†: $file"
            fi
          done
          
          echo "âœ… ØªØ­Ù„ÙŠÙ„ Fortify Ù…ÙƒØªÙ…Ù„"
          EOF
          
          chmod +x fortify-analysis.sh
          ./fortify-analysis.sh > fortify-report.txt
          
          cat fortify-report.txt
      
      - name: ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Fortify
        run: |
          echo "ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬..."
          
          critical=$(grep -c "ğŸš¨" fortify-report.txt || echo "0")
          high=$(grep -c "âš ï¸" fortify-report.txt || echo "0")
          
          cat << EOF > fortify-summary.json
          {
            "scan_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "critical_issues": $critical,
            "high_issues": $high,
            "status": "$([ $critical -eq 0 ] && echo 'PASSED' || echo 'FAILED')"
          }
          EOF
          
          echo "ğŸ“‹ Ù…Ù„Ø®Øµ Fortify:"
          cat fortify-summary.json | jq '.'
      
      - name: ğŸ“¤ Ø±ÙØ¹ Ù†ØªØ§Ø¦Ø¬ Fortify
        uses: actions/upload-artifact@v4
        with:
          name: fortify-sca-results
          path: |
            fortify-report.txt
            fortify-summary.json
          retention-days: 90

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: ØªØ­ØµÙŠÙ† Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
  # ========================================
  dependency-fortification:
    name: ğŸ“¦ ØªØ­ØµÙŠÙ† Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
    runs-on: ubuntu-latest
    needs: security-assessment
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
      
      - name: ğŸ“¦ ØªØ¯Ù‚ÙŠÙ‚ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        run: |
          if [ -f package.json ]; then
            echo "ğŸ“¦ ÙØ­Øµ ØªØ¨Ø¹ÙŠØ§Øª NPM..."
            
            # ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
            npm ci
            
            # ØªØ¯Ù‚ÙŠÙ‚ Ø´Ø§Ù…Ù„
            npm audit --json > npm-audit-full.json || true
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            if [ "${{ env.AUTO_FIX }}" == "true" ]; then
              echo "ğŸ”§ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ..."
              npm audit fix --force || true
              npm audit fix || true
            fi
            
            # ÙØ­Øµ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            npx npm-check-updates -u --target minor > ncu-report.txt || true
            
            # ØªØ­Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ø­Ø²Ù…
            npx cost-of-modules --less > package-sizes.txt || true
          fi
      
      - name: ğŸ”’ Snyk - Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=high --json-file-output=snyk-deps.json
      
      - name: ğŸ›¡ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ø¢Ù…Ù†Ø©
        run: |
          cat << 'EOF' > generate-safe-deps.sh
          #!/bin/bash
          
          echo "ğŸ”’ Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ø¢Ù…Ù†Ø©..."
          
          if [ -f package.json ]; then
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
            jq -r '.dependencies, .devDependencies | keys[]' package.json > all-deps.txt
            
            # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø©
            cat << 'SAFE' > safe-dependencies.json
            {
              "trusted_packages": [
                "express",
                "react",
                "vue",
                "axios",
                "lodash",
                "moment",
                "dotenv"
              ],
              "security_score": "high",
              "last_updated": "$(date -u +%Y-%m-%d)"
            }
          SAFE
          fi
          
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ø¢Ù…Ù†Ø©"
          EOF
          
          chmod +x generate-safe-deps.sh
          ./generate-safe-deps.sh
      
      - name: ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù…Ø­ØµÙ†Ø©
        run: |
          cat << EOF > dependency-fortification-report.md
          # ğŸ“¦ ØªÙ‚Ø±ÙŠØ± ØªØ­ØµÙŠÙ† Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
          
          ## ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          - **Ø§Ù„ØªØ§Ø±ÙŠØ®**: $(date '+%Y-%m-%d %H:%M:%S')
          - **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª**: $([ -f package.json ] && jq '.dependencies, .devDependencies | length' package.json || echo "0")
          - **Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©**: ${{ env.AUTO_FIX }}
          
          ## ğŸ”’ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©
          - âœ… ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
          - âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ø¶Ø¹ÙŠÙØ©
          - âœ… ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©
          - âœ… Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ø¢Ù…Ù†Ø©
          
          EOF
          
          cat dependency-fortification-report.md
      
      - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        uses: actions/upload-artifact@v4
        with:
          name: dependency-fortification
          path: |
            npm-audit-full.json
            snyk-deps.json
            safe-dependencies.json
            dependency-fortification-report.md
          retention-days: 90

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: ØªØ­ØµÙŠÙ† Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ©
  # ========================================
  infrastructure-hardening:
    name: ğŸ—ï¸ ØªØ­ØµÙŠÙ† Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ©
    runs-on: ubuntu-latest
    needs: security-assessment
    timeout-minutes: 25
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ³ ØªØ­ØµÙŠÙ† Docker
        if: hashFiles('Dockerfile') != ''
        run: |
          cat << 'EOF' > hardened-dockerfile
          # Dockerfile Ù…Ø­ØµÙ† - Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø£Ø³Ø§Ø³ÙŠØ© Ø¢Ù…Ù†Ø© ÙˆÙ…Ø­Ø¯Ø«Ø©
          FROM node:18-alpine3.18 AS builder
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root
          RUN addgroup -g 1001 -S appgroup && \
              adduser -S appuser -u 1001 -G appgroup
          
          # ØªØ¹ÙŠÙŠÙ† Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„
          WORKDIR /app
          
          # Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª ÙÙ‚Ø· Ø£ÙˆÙ„Ø§Ù‹
          COPY --chown=appuser:appgroup package*.json ./
          
          # ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
          RUN npm ci --only=production --no-audit --no-fund && \
              npm cache clean --force
          
          # Ù†Ø³Ø® Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª
          COPY --chown=appuser:appgroup . .
          
          # Ø§Ù„Ø¨Ù†Ø§Ø¡
          RUN npm run build || true
          
          # Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
          FROM node:18-alpine3.18
          
          # ØªØ«Ø¨ÙŠØª dumb-init Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
          RUN apk add --no-cache dumb-init
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…
          RUN addgroup -g 1001 -S appgroup && \
              adduser -S appuser -u 1001 -G appgroup
          
          WORKDIR /app
          
          # Ù†Ø³Ø® Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
          COPY --from=builder --chown=appuser:appgroup /app/node_modules ./node_modules
          COPY --from=builder --chown=appuser:appgroup /app/dist ./dist
          COPY --from=builder --chown=appuser:appgroup /app/package*.json ./
          
          # Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø§Ù„Ù…Ù…ÙŠØ²
          USER appuser
          
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
          ENV NODE_ENV=production \
              NODE_OPTIONS="--max-old-space-size=2048" \
              NPM_CONFIG_LOGLEVEL=warn
          
          # ÙØ­Øµ Ø§Ù„ØµØ­Ø©
          HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
            CMD node healthcheck.js
          
          # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ù†ÙØ°
          EXPOSE 3000
          
          # Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
          ENTRYPOINT ["dumb-init", "--"]
          CMD ["node", "dist/index.js"]
          EOF
          
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Dockerfile Ù…Ø­ØµÙ†"
          
          # Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Dockerfile Ø§Ù„Ø­Ø§Ù„ÙŠ
          if [ -f Dockerfile ]; then
            echo "ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Dockerfile:"
            diff Dockerfile hardened-dockerfile || true
          fi
      
      - name: ğŸ”’ ØªØ­ØµÙŠÙ† Nginx
        run: |
          cat << 'EOF' > nginx-hardened.conf
          # Nginx Configuration - Ù…Ø­ØµÙ† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
          
          user nginx;
          worker_processes auto;
          error_log /var/log/nginx/error.log warn;
          pid /var/run/nginx.pid;
          
          events {
              worker_connections 2048;
              use epoll;
          }
          
          http {
              include /etc/nginx/mime.types;
              default_type application/octet-stream;
              
              # ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
              sendfile on;
              tcp_nopush on;
              tcp_nodelay on;
              keepalive_timeout 65;
              types_hash_max_size 2048;
              
              # Ø¥Ø®ÙØ§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø³Ø®Ø©
              server_tokens off;
              
              # Ø­Ù…Ø§ÙŠØ© Ù…Ù† Clickjacking
              add_header X-Frame-Options "SAMEORIGIN" always;
              
              # Ø­Ù…Ø§ÙŠØ© XSS
              add_header X-XSS-Protection "1; mode=block" always;
              
              # Ø­Ù…Ø§ÙŠØ© MIME
              add_header X-Content-Type-Options "nosniff" always;
              
              # HSTS
              add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
              
              # CSP
              add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
              
              # Referrer Policy
              add_header Referrer-Policy "strict-origin-when-cross-origin" always;
              
              # Ø­Ù…Ø§ÙŠØ© Ù…Ù† DDoS
              limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;
              limit_conn_zone $binary_remote_addr zone=addr:10m;
              
              server {
                  listen 443 ssl http2;
                  server_name digital-warrior.com;
                  
                  # SSL Configuration
                  ssl_certificate /etc/nginx/ssl/cert.pem;
                  ssl_certificate_key /etc/nginx/ssl/key.pem;
                  ssl_protocols TLSv1.2 TLSv1.3;
                  ssl_ciphers HIGH:!aNULL:!MD5;
                  ssl_prefer_server_ciphers on;
                  
                  # Ø­Ù…Ø§ÙŠØ© DDoS
                  limit_req zone=one burst=20 nodelay;
                  limit_conn addr 10;
                  
                  root /var/www/html;
                  index index.html;
                  
                  location / {
                      try_files $uri $uri/ =404;
                  }
                  
                  # Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
                  location ~ /\. {
                      deny all;
                      access_log off;
                      log_not_found off;
                  }
              }
          }
          EOF
          
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙƒÙˆÙŠÙ† Nginx Ù…Ø­ØµÙ†"
      
      - name: ğŸ” Ø¥Ù†Ø´Ø§Ø¡ Security Headers
        run: |
          cat << 'EOF' > security-headers.js
          // Security Headers Middleware - ØªØ­ØµÙŠÙ† Ø´Ø§Ù…Ù„
          
          module.exports = function securityHeaders(req, res, next) {
            // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Clickjacking
            res.setHeader('X-Frame-Options', 'SAMEORIGIN');
            
            // Ø­Ù…Ø§ÙŠØ© XSS
            res.setHeader('X-XSS-Protection', '1; mode=block');
            
            // Ø­Ù…Ø§ÙŠØ© MIME Type
            res.setHeader('X-Content-Type-Options', 'nosniff');
            
            // HSTS
            res.setHeader(
              'Strict-Transport-Security',
              'max-age=31536000; includeSubDomains; preload'
            );
            
            // CSP
            res.setHeader(
              'Content-Security-Policy',
              "default-src 'self'; " +
              "script-src 'self' 'unsafe-inline' 'unsafe-eval'; " +
              "style-src 'self' 'unsafe-inline'; " +
              "img-src 'self' data: https:; " +
              "font-src 'self' data:; " +
              "connect-src 'self'; " +
              "frame-ancestors 'none';"
            );
            
            // Referrer Policy
            res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
            
            // Permissions Policy
            res.setHeader(
              'Permissions-Policy',
              'geolocation=(), microphone=(), camera=()'
            );
            
            // Ø¥Ø®ÙØ§Ø¡ ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø³ÙŠØ±ÙØ±
            res.removeHeader('X-Powered-By');
            
            next();
          };
          EOF
          
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Security Headers Middleware"
      
      - name: ğŸ“¤ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ­ØµÙŠÙ†
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-hardening
          path: |
            hardened-dockerfile
            nginx-hardened.conf
            security-headers.js
          retention-days: 90

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: ØªØ­ØµÙŠÙ† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  # ========================================
  database-hardening:
    name: ğŸ—„ï¸ ØªØ­ØµÙŠÙ† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    runs-on: ubuntu-latest
    needs: security-assessment
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: ğŸ”’ Ø¥Ù†Ø´Ø§Ø¡ Connection Pool Ø¢Ù…Ù†
        run: |
          cat << 'EOF' > database-config-secure.js
          // Database Configuration - Ù…Ø­ØµÙ† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
          
          const { Pool } = require('pg');
          const mongoose = require('mongoose');
          
          // PostgreSQL Secure Connection Pool
          const pgPool = new Pool({
            user: process.env.DB_USER,
            host: process.env.DB_HOST,
            database: process.env.DB_NAME,
            password: process.env.DB_PASSWORD,
            port: process.env.DB_PORT || 5432,
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
            ssl: {
              rejectUnauthorized: true,
              ca: process.env.DB_CA_CERT,
              cert: process.env.DB_CLIENT_CERT,
              key: process.env.DB_CLIENT_KEY
            },
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø£Ù…Ø§Ù†
            max: 20,
            min: 5,
            idleTimeoutMillis: 30000,
            connectionTimeoutMillis: 2000,
            
            // Ø­Ù…Ø§ÙŠØ© Ù…Ù† SQL Injection
            statement_timeout: 10000,
            query_timeout: 10000
          });
          
          // MongoDB Secure Connection
          const mongooseOptions = {
            useNewUrlParser: true,
            useUnifiedTopology: true,
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
            ssl: true,
            sslValidate: true,
            sslCA: process.env.MONGO_CA_CERT,
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
            maxPoolSize: 10,
            minPoolSize: 5,
            serverSelectionTimeoutMS: 5000,
            socketTimeoutMS: 45000,
            
            // Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
            retryWrites: true,
            w: 'majority'
          };
          
          // Ø¯Ø§Ù„Ø© Sanitization Ù„Ù…Ù†Ø¹ NoSQL Injection
          function sanitizeInput(input) {
            if (typeof input === 'object' && input !== null) {
              Object.keys(input).forEach(key => {
                if (key.startsWith('$')) {
                  delete input[key];
                }
              });
            }
            return input;
          }
          
          // Prepared Statements Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† SQL Injection
          async function secureQuery(query, params) {
            const client = await pgPool.connect();
            try {
              // Ø§Ø³ØªØ®Ø¯Ø§Ù… parameterized queries
              const result = await client.query(query, params);
              return result.rows;
            } catch (error) {
              console.error('Database error:', error.message);
              throw new Error('Database operation failed');
            } finally {
              client.release();
            }
          }
          
          module.exports = {
            pgPool,
            mongooseOptions,
            sanitizeInput,
            secureQuery
          };
          EOF
          
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙƒÙˆÙŠÙ† Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ØµÙ†"
      
      - name: ğŸ›¡ï¸ Ø¥Ù†Ø´Ø§Ø¡ Query Validator
        run: |
          cat << 'EOF' > query-validator.js
          // Query Validator - Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø­Ù‚Ù†
          
          class QueryValidator {
            constructor() {
              this.sqlInjectionPatterns = [
                /(\s|^)(union|select|insert|update|delete|drop|create|alter|exec|execute)(\s|$)/i,
                /'(\s|)(or|and)(\s|)'/i,
                /--/,
                /;(\s|)drop/i,
                /xp_/i,
                /sp_/i
              ];
              
              this.nosqlInjectionPatterns = [
                /\$where/i,
                /\$ne/,
                /\$gt/,
                /\$regex/,
                /javascript:/i
              ];
            }
            
            validateSQL(query) {
              for (const pattern of this.sqlInjectionPatterns) {
                if (pattern.test(query)) {
                  throw new Error('Potential SQL injection detected');
                }
              }
              return true;
            }
            
            validateNoSQL(query) {
              const queryString = JSON.stringify(query);
              for (const pattern of this.nosqlInjectionPatterns) {
                if (pattern.test(queryString)) {
                  throw new Error('Potential NoSQL injection detected');
                }
              }
              return true;
            }
            
            sanitize(input) {
              if (typeof input === 'string') {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø®Ø·Ø±Ø©
                return input
                  .replace(/[^\w\s@.-]/g, '')
                  .trim();
              }
              return input;
            }
          }
          
          module.exports = new QueryValidator();
          EOF
          
          echo "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Query Validator"
      
      - name: ğŸ“¤ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª ØªØ­ØµÙŠÙ† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        uses: actions/upload-artifact@v4
        with:
          name: database-hardening
          path: |
            database-config-secure.js
            query-validator.js
          retention-days: 90

  # ========================================
  # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: ØªØ­ØµÙŠÙ† API
  # ========================================
  api-fortification:
    name: ğŸ”Œ ØªØ­ØµÙŠÙ† API
    runs-on: ubuntu-latest
    needs: security-assessment
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§
