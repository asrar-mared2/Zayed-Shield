name: Secure Deploy to GitHub Pages (Ultra 2025)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-deploy"
  cancel-in-progress: false

jobs:

  deploy:
    name: Hardened Static Pages Deployment
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    timeout-minutes: 20

    steps:
      - name: ğŸ›¡ï¸ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø£Ù…Ø§Ù†
        run: |
          set -euo pipefail
          echo "ğŸ” Secure mode enabled"

      - name: â¬‡ï¸ Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù€ Commit ÙˆØªÙˆÙ‚ÙŠØ¹Ù‡
        run: |
          git verify-commit HEAD || (echo "âŒ Commit signature invalid!" && exit 1)
          echo "âœ”ï¸ Commit signature verified"

      - name: ğŸ§¹ ÙØ­Øµ Ø§Ù„Ø£Ø³Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        uses: gitleaks/gitleaks-action@v2

      - name: ğŸ§© ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ Ù„Ø£Ø¯Ø§Ø¡ Ø£Ø³Ø±Ø¹
        uses: actions/cache@v4
        with:
          path: ~/.cache/pages-cache
          key: pages-${{ github.sha }}
          restore-keys: |
            pages-

      - name: ğŸ” ÙØ­Øµ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙØ©
        run: |
          echo "ğŸ” Scanning for broken links..."
          if command -v linkchecker >/dev/null; then
            linkchecker . || true
          else
            echo "âš ï¸ linkchecker not installed â€” skipping"
          fi

      - name: ğŸ“ ØªØ­Ù„ÙŠÙ„ HTML/CSS (Linting)
        run: |
          echo "ğŸ§ª Running HTML/CSS lint..."
          if command -v htmlhint >/dev/null; then
            htmlhint . || true
          else
            echo "âš ï¸ htmlhint not installed â€” skipping"
          fi

      - name: ğŸ§® ÙØ­Øµ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø±
        run: |
          echo "ğŸ“¦ Checking file sizes..."
          max_size=5242880 # 5MB
          while IFS= read -r file; do
            size=$(stat -c%s "$file")
            if [ $size -gt $max_size ]; then
              echo "âŒ File too large: $file ($size bytes)"
              exit 1
            fi
          done < <(find . -type f)
          echo "âœ”ï¸ All files within limits"

      - name: ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡Ø§Ø´ Ø§Ù„Ù…Ù„ÙØ§Øª (SHA256)
        run: |
          echo "ğŸ”’ Generating file integrity SHA256..."
          find . -type f -exec sha256sum {} \;

      - name: âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ GitHub Pages
        uses: actions/configure-pages@v5

      - name: ğŸ“¦ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: ğŸš€ Ù†Ø´Ø± GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„
        run: |
          rm -rf ~/.cache || true
          echo "ğŸ§½ Workspace cleaned."

      - name: ğŸ“£ Ø¥Ø±Ø³Ø§Ù„ Summary ÙˆØ§Ø¶Ø­
        uses: actions/github-script@v7
        with:
          script: |
            core.summary
              .addHeading("GitHub Pages Deployment Summary")
              .addRaw("âœ”ï¸ Deployment completed successfully.<br>")
              .addRaw("ğŸ” Security checks passed.<br>")
              .addRaw("ğŸ“¤ Pages published to: ${{
                steps.deployment.outputs.page_url
              }}")
              .write()
